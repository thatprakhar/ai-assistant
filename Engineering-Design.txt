

{"type":"excalidraw/clipboard","elements":[{"id":"CszWwCx1voCl5ikJ03WeA","type":"text","x":6266.635737317287,"y":-2006.4128216753506,"width":1550,"height":90,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":4,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3R","roundness":null,"seed":2108436468,"version":36,"versionNonce":289722868,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"WhatsApp → Master Agent (LangGraph) → Tools/Sub-Agents (Single-machine, Business API)","fontSize":52,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"WhatsApp → Master Agent (LangGraph) → Tools/Sub-Agents (Single-machine, Business API)","autoResize":true,"lineHeight":1.25},{"id":"UfACLUi3kVwZwLuuxmTt8","type":"rectangle","x":9566.635737317287,"y":-2006.4128216753506,"width":900,"height":520,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3S","roundness":{"type":3},"seed":1443500404,"version":36,"versionNonce":1916695412,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"ofCVG-zu5Sm5-oh9sLLJH","type":"text","x":9601.635737317287,"y":-1981.4128216753506,"width":320,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3T","roundness":null,"seed":2066727668,"version":36,"versionNonce":378004724,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Legend","fontSize":36,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Legend","autoResize":true,"lineHeight":1.25},{"id":"A8v0V5d70aHCv8gf8e7RA","type":"text","x":9601.635737317287,"y":-1926.4128216753506,"width":850,"height":440,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3U","roundness":null,"seed":597902452,"version":36,"versionNonce":598156916,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Solid arrows: synchronous call/response\nDashed arrows: async / queued or buffered\n\"Idempotency\": dedupe key per inbound message\n\"RunId\": unique id for a conversation/run thread\n\"Checkpoint\": persisted snapshot for resume\n\nDesign goal: WhatsApp is UI + event source only.\nYour system owns state, retries, backpressure, and durability.","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Solid arrows: synchronous call/response\nDashed arrows: async / queued or buffered\n\"Idempotency\": dedupe key per inbound message\n\"RunId\": unique id for a conversation/run thread\n\"Checkpoint\": persisted snapshot for resume\n\nDesign goal: WhatsApp is UI + event source only.\nYour system owns state, retries, backpressure, and durability.","autoResize":true,"lineHeight":1.25},{"id":"YJdhMH5KDeIMi4UNHISHV","type":"rectangle","x":9266.635737317287,"y":-1456.4128216753506,"width":1200,"height":870,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3V","roundness":{"type":3},"seed":1160418804,"version":36,"versionNonce":509753332,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"3jDy85FH_NTY7gE-8MQeg","type":"text","x":9301.635737317287,"y":-1431.4128216753506,"width":420,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3W","roundness":null,"seed":751548276,"version":36,"versionNonce":46078324,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"External Surface","fontSize":34,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"External Surface","autoResize":true,"lineHeight":1.25},{"id":"7RoTQQciAbMINiO-YgQIk","type":"ellipse","x":10166.635737317287,"y":-1296.4128216753506,"width":250,"height":250,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3X","roundness":{"type":2},"seed":382511348,"version":36,"versionNonce":1543752436,"isDeleted":false,"boundElements":[{"id":"0P6Ih4oO5qtLj3evdz5Du","type":"arrow"},{"id":"MzmZToJMYycGz-iK1eECQ","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"fvrbFWB9uiM2QHcPMo6HT","type":"text","x":10236.635737317287,"y":-1181.4128216753506,"width":100,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3Y","roundness":null,"seed":1186163316,"version":36,"versionNonce":1555450996,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"You","fontSize":40,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"You","autoResize":true,"lineHeight":1.25},{"id":"poUHX1MF6o9vgGjV5Q6Ez","type":"rectangle","x":9366.635737317287,"y":-1341.4128216753506,"width":700,"height":350,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3Z","roundness":{"type":3},"seed":524680180,"version":36,"versionNonce":1989975540,"isDeleted":false,"boundElements":[{"id":"0P6Ih4oO5qtLj3evdz5Du","type":"arrow"},{"id":"MzmZToJMYycGz-iK1eECQ","type":"arrow"},{"id":"ZPdMxkQEMUtn-le39FuHh","type":"arrow"},{"id":"u6k7F54thTRFuD8eWwkF-","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"qUNZb8Nnsl_HNeU8LIOnX","type":"text","x":9401.635737317287,"y":-1316.4128216753506,"width":650,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3a","roundness":null,"seed":982146420,"version":36,"versionNonce":1924972404,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"WhatsApp (Business API)","fontSize":34,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"WhatsApp (Business API)","autoResize":true,"lineHeight":1.25},{"id":"PMQeBarVQdjlxuYCls4Hb","type":"text","x":9401.635737317287,"y":-1261.4128216753506,"width":650,"height":235,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3b","roundness":null,"seed":29789940,"version":36,"versionNonce":157069556,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Does:\n- deliver inbound message events (webhook)\n- deliver outbound messages (send API)\n\nDoes NOT guarantee:\n- exactly-once\n- strict ordering\n- replay safety","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Does:\n- deliver inbound message events (webhook)\n- deliver outbound messages (send API)\n\nDoes NOT guarantee:\n- exactly-once\n- strict ordering\n- replay safety","autoResize":true,"lineHeight":1.25},{"id":"0P6Ih4oO5qtLj3evdz5Du","type":"arrow","x":10154.635737317287,"y":-1161.4128216753506,"width":95,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3c","roundness":{"type":2},"seed":1166053492,"version":36,"versionNonce":2046980724,"isDeleted":false,"boundElements":[{"type":"text","id":"5T8F6ylCDlrj-QYztEYV-"}],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-95,0]],"startBinding":{"elementId":"7RoTQQciAbMINiO-YgQIk","mode":"orbit","fixedPoint":[0,0.5001]},"endBinding":{"elementId":"poUHX1MF6o9vgGjV5Q6Ez","mode":"orbit","fixedPoint":[1,0.53]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"5T8F6ylCDlrj-QYztEYV-","type":"text","x":9596.837870495998,"y":-1301.2956341753506,"width":70.75198364257812,"height":40,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3d","roundness":null,"seed":1434345972,"version":5,"versionNonce":1042895604,"isDeleted":false,"boundElements":[],"updated":1771967922120,"link":null,"locked":false,"text":"send","fontSize":32,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"0P6Ih4oO5qtLj3evdz5Du","originalText":"send","autoResize":true,"lineHeight":1.25},{"id":"MzmZToJMYycGz-iK1eECQ","type":"arrow","x":10059.635737317287,"y":-1111.4128216753506,"width":95,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3e","roundness":{"type":2},"seed":415630196,"version":36,"versionNonce":594805748,"isDeleted":false,"boundElements":[{"type":"text","id":"p8MkI8DTmGx_S9jw2WZLa"}],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[95,0]],"startBinding":{"elementId":"poUHX1MF6o9vgGjV5Q6Ez","mode":"orbit","fixedPoint":[1,0.67]},"endBinding":{"elementId":"7RoTQQciAbMINiO-YgQIk","mode":"orbit","fixedPoint":[0,0.67]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"p8MkI8DTmGx_S9jw2WZLa","type":"text","x":9596.677882092677,"y":-1251.2956341753506,"width":71.07196044921875,"height":40,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3f","roundness":null,"seed":631076084,"version":5,"versionNonce":1894438004,"isDeleted":false,"boundElements":[],"updated":1771967922120,"link":null,"locked":false,"text":"reply","fontSize":32,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"MzmZToJMYycGz-iK1eECQ","originalText":"reply","autoResize":true,"lineHeight":1.25},{"id":"k_cjIuFZ-33igNvjIfz5u","type":"rectangle","x":5866.635737317287,"y":-1456.4128216753506,"width":3300,"height":1680,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3g","roundness":{"type":3},"seed":1502262900,"version":36,"versionNonce":465003892,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"WMAVsOQ_UuabQ4ffvpLC4","type":"text","x":5901.635737317287,"y":-1431.4128216753506,"width":520,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3h","roundness":null,"seed":1901316084,"version":36,"versionNonce":1209177844,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Single Machine Runtime","fontSize":34,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Single Machine Runtime","autoResize":true,"lineHeight":1.25},{"id":"b_97tml29qBGMraczwONF","type":"rectangle","x":8716.635737317287,"y":-1336.4128216753506,"width":400,"height":240,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3i","roundness":{"type":3},"seed":553560436,"version":36,"versionNonce":1963694196,"isDeleted":false,"boundElements":[{"id":"ZPdMxkQEMUtn-le39FuHh","type":"arrow"},{"id":"5uUw-WB2AR2ySWLffmX7I","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"9T0oZ2ARyTy3kUUGVUBu9","type":"text","x":8741.635737317287,"y":-1311.4128216753506,"width":360,"height":200,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3j","roundness":null,"seed":735140596,"version":36,"versionNonce":1852336628,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Webhook Endpoint\n(HTTP server)\n- verifies signature\n- parses event\n- extracts messageId\n- extracts chatId\n","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Webhook Endpoint\n(HTTP server)\n- verifies signature\n- parses event\n- extracts messageId\n- extracts chatId\n","autoResize":true,"lineHeight":1.25},{"id":"ZPdMxkQEMUtn-le39FuHh","type":"arrow","x":9356.635737317287,"y":-1056.4128216753506,"width":230,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3k","roundness":{"type":2},"seed":2085739636,"version":36,"versionNonce":388959092,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-230,0]],"startBinding":{"elementId":"poUHX1MF6o9vgGjV5Q6Ez","mode":"orbit","fixedPoint":[0,0.82]},"endBinding":{"elementId":"b_97tml29qBGMraczwONF","mode":"orbit","fixedPoint":[1,0.58]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"LFOuPMjlWbiask5ixRZ3T","type":"rectangle","x":8266.635737317287,"y":-1336.4128216753506,"width":420,"height":520,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3l","roundness":{"type":3},"seed":1011232244,"version":36,"versionNonce":27622644,"isDeleted":false,"boundElements":[{"id":"5uUw-WB2AR2ySWLffmX7I","type":"arrow"},{"id":"_i2meEbdQy07mZkhUIodO","type":"arrow"},{"id":"QIyvleGhfxQVpyNzwJjJ0","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"TpT-huXgblnZ7XtvUSiBJ","type":"text","x":8291.635737317287,"y":-1311.4128216753506,"width":390,"height":490,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3m","roundness":null,"seed":1823756148,"version":36,"versionNonce":122797684,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Channel Gateway (Ingress)\n- idempotency check\n  key = (chatId, messageId)\n- normalize text/media\n- assign threadKey\n  (single user → one thread)\n- create runId if needed\n- write inbound event to Run Store\n- hand off to Master Agent","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Channel Gateway (Ingress)\n- idempotency check\n  key = (chatId, messageId)\n- normalize text/media\n- assign threadKey\n  (single user → one thread)\n- create runId if needed\n- write inbound event to Run Store\n- hand off to Master Agent","autoResize":true,"lineHeight":1.25},{"id":"5uUw-WB2AR2ySWLffmX7I","type":"arrow","x":8711.635737317287,"y":-1206.4128216753506,"width":25,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3n","roundness":{"type":2},"seed":2111979764,"version":36,"versionNonce":1626984436,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-25,0]],"startBinding":{"elementId":"b_97tml29qBGMraczwONF","mode":"orbit","fixedPoint":[0,0.55]},"endBinding":{"elementId":"LFOuPMjlWbiask5ixRZ3T","mode":"orbit","fixedPoint":[1,0.55]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"OPM2rqK2rKxwB1GfxC_rr","type":"rectangle","x":6516.635737317287,"y":-1396.4128216753506,"width":1650,"height":980,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3o","roundness":{"type":3},"seed":1733689972,"version":36,"versionNonce":1050915188,"isDeleted":false,"boundElements":[{"id":"QIyvleGhfxQVpyNzwJjJ0","type":"arrow"},{"id":"wZhWveVq16uOm6jvonO7V","type":"arrow"},{"id":"QXMfcU0J6Y3MdGA2K4lFN","type":"arrow"},{"id":"D4OFMt2PyWAtIQaRrzYNv","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"_URmF76Y03wKr4_WmY1Gb","type":"text","x":6551.635737317287,"y":-1371.4128216753506,"width":900,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3p","roundness":null,"seed":1070961652,"version":36,"versionNonce":1603625716,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Master Agent (Node.js process)","fontSize":38,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Master Agent (Node.js process)","autoResize":true,"lineHeight":1.25},{"id":"9szUEpiN2UAFNZMB6rMg4","type":"rectangle","x":6566.635737317287,"y":-1301.4128216753506,"width":790,"height":380,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3q","roundness":{"type":3},"seed":1432810868,"version":36,"versionNonce":710206580,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"iy1et__6ISEKq_UFknX_n","type":"text","x":6591.635737317287,"y":-1276.4128216753506,"width":760,"height":340,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3r","roundness":null,"seed":1162880756,"version":36,"versionNonce":1151874548,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"LangGraph Orchestrator\n(controls control-flow)\n\nInputs:\n- inbound message (normalized)\n- memory snapshot\n- last run state\n\nOutputs:\n- next action(s)\n  * direct tool call\n  * spawn long-job sub-agent\n  * send response\n\nResponsibilities:\n- decide \"trivial\" vs \"complex long\"\n- trigger retries policy per step\n- checkpoint after each step","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"LangGraph Orchestrator\n(controls control-flow)\n\nInputs:\n- inbound message (normalized)\n- memory snapshot\n- last run state\n\nOutputs:\n- next action(s)\n  * direct tool call\n  * spawn long-job sub-agent\n  * send response\n\nResponsibilities:\n- decide \"trivial\" vs \"complex long\"\n- trigger retries policy per step\n- checkpoint after each step","autoResize":true,"lineHeight":1.25},{"id":"bPwEpkU1gYSBG1gzxHosr","type":"rectangle","x":7386.635737317287,"y":-1301.4128216753506,"width":740,"height":380,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3s","roundness":{"type":3},"seed":337062004,"version":36,"versionNonce":731207540,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"0LA8Vig_IuHTnI0QB8217","type":"text","x":7411.635737317287,"y":-1276.4128216753506,"width":700,"height":350,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3t","roundness":null,"seed":1166146036,"version":36,"versionNonce":1264732404,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Heuristic: \"Complex long job\" triggers sub-agent\nExample triggers (explicitly defined):\n- expected runtime > 20–30s\n- multi-step research / browsing\n- codebase changes across many files\n- high uncertainty → needs exploration\n- needs parallelism (N subtasks)\n\nOtherwise: Master calls tools directly\n\nNote: not deterministic → ok\n(but validate outputs / handle retries)","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Heuristic: \"Complex long job\" triggers sub-agent\nExample triggers (explicitly defined):\n- expected runtime > 20–30s\n- multi-step research / browsing\n- codebase changes across many files\n- high uncertainty → needs exploration\n- needs parallelism (N subtasks)\n\nOtherwise: Master calls tools directly\n\nNote: not deterministic → ok\n(but validate outputs / handle retries)","autoResize":true,"lineHeight":1.25},{"id":"pGS5CPB0mWTO3lqSGGCoh","type":"rectangle","x":6566.635737317287,"y":-896.4128216753506,"width":1560,"height":440,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3u","roundness":{"type":3},"seed":1956027252,"version":36,"versionNonce":395643508,"isDeleted":false,"boundElements":[{"id":"ku8hEyIzOeqoW8-zjfuO6","type":"arrow"},{"id":"U73DnRNNrVXbEULi-RMuA","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"VK2whHZViI8mWxaVsP8uA","type":"text","x":6591.635737317287,"y":-871.4128216753506,"width":1530,"height":395,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3v","roundness":null,"seed":1805323508,"version":36,"versionNonce":586390516,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Sub-Agent Scheduler + IPC Router\n(same machine)\n\n- spawns Node.js sub-agent processes (no WhatsApp)\n- assigns subtaskId, ties to runId\n- manages concurrency (max N sub-agents)\n- per-subtask timeouts\n- collects results + partial progress\n- retries (as instructed by orchestrator)\n\nIPC options:\n- child_process stdio + JSON lines\n- Unix sockets\n- local HTTP\n- messagepack (optional)","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Sub-Agent Scheduler + IPC Router\n(same machine)\n\n- spawns Node.js sub-agent processes (no WhatsApp)\n- assigns subtaskId, ties to runId\n- manages concurrency (max N sub-agents)\n- per-subtask timeouts\n- collects results + partial progress\n- retries (as instructed by orchestrator)\n\nIPC options:\n- child_process stdio + JSON lines\n- Unix sockets\n- local HTTP\n- messagepack (optional)","autoResize":true,"lineHeight":1.25},{"id":"QIyvleGhfxQVpyNzwJjJ0","type":"arrow","x":8256.635737317287,"y":-1076.4128216753506,"width":85,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3w","roundness":{"type":2},"seed":1008029300,"version":36,"versionNonce":931396980,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-85,0]],"startBinding":{"elementId":"LFOuPMjlWbiask5ixRZ3T","mode":"orbit","fixedPoint":[0,0.5001]},"endBinding":{"elementId":"OPM2rqK2rKxwB1GfxC_rr","mode":"orbit","fixedPoint":[1,0.33]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"AqHekOCSTF7MMW-AlDBYo","type":"rectangle","x":5916.635737317287,"y":-1336.4128216753506,"width":540,"height":560,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3x","roundness":{"type":3},"seed":1456168948,"version":36,"versionNonce":1854680820,"isDeleted":false,"boundElements":[{"id":"_i2meEbdQy07mZkhUIodO","type":"arrow"},{"id":"wZhWveVq16uOm6jvonO7V","type":"arrow"},{"id":"bMOnefXhLEWjm8tYZVRZW","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"gzw4qklmvcmCzE4z0rY5Z","type":"text","x":5946.635737317287,"y":-1311.4128216753506,"width":500,"height":520,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3y","roundness":null,"seed":599998836,"version":36,"versionNonce":1217540212,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Run Store (local DB)\n(SQLite/Postgres)\n\nTables/records:\n- inbound_events\n  * messageId, chatId, ts\n  * idempotency status\n- runs\n  * runId, state, threadKey\n- steps\n  * stepId, tool/subtask, status\n- checkpoints\n  * stepId → snapshot pointer\n- memory\n  * consolidated user memory\n\nUsed for:\n- resume after crash\n- dedupe inbound\n- reconstruct timeline","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Run Store (local DB)\n(SQLite/Postgres)\n\nTables/records:\n- inbound_events\n  * messageId, chatId, ts\n  * idempotency status\n- runs\n  * runId, state, threadKey\n- steps\n  * stepId, tool/subtask, status\n- checkpoints\n  * stepId → snapshot pointer\n- memory\n  * consolidated user memory\n\nUsed for:\n- resume after crash\n- dedupe inbound\n- reconstruct timeline","autoResize":true,"lineHeight":1.25},{"id":"_i2meEbdQy07mZkhUIodO","type":"arrow","x":8256.635737317287,"y":-861.4128216753506,"width":1780,"height":520,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b3z","roundness":{"type":2},"seed":440595188,"version":36,"versionNonce":1163657716,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-1200,0],[-1200,520],[-1780,520]],"startBinding":{"elementId":"LFOuPMjlWbiask5ixRZ3T","mode":"orbit","fixedPoint":[0,0.92]},"endBinding":{"elementId":"AqHekOCSTF7MMW-AlDBYo","mode":"orbit","fixedPoint":[1,0.82]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"wZhWveVq16uOm6jvonO7V","type":"arrow","x":6516.635737317287,"y":-896.4128216753506,"width":120,"height":240,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b40","roundness":{"type":2},"seed":1490056308,"version":36,"versionNonce":2079302516,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-120,0],[-120,240]],"startBinding":{"elementId":"OPM2rqK2rKxwB1GfxC_rr","mode":"orbit","fixedPoint":[0,0.73]},"endBinding":{"elementId":"AqHekOCSTF7MMW-AlDBYo","mode":"orbit","fixedPoint":[1,0.25]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"8ZJhy9Aa44_v93wbTVZWd","type":"rectangle","x":5916.635737317287,"y":-731.4128216753506,"width":540,"height":220,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b41","roundness":{"type":3},"seed":1026672116,"version":36,"versionNonce":848499956,"isDeleted":false,"boundElements":[{"id":"ItqoDpN0Oxg9zNT5TTo94","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"wBwaVJXKPeoQCN5D4Xnjg","type":"text","x":5946.635737317287,"y":-706.4128216753506,"width":500,"height":190,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b42","roundness":null,"seed":2087511924,"version":36,"versionNonce":1993102964,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Checkpoint Writer\n\nOn each step completion:\n- serialize minimal state\n  (messages, tool outputs, plan)\n- write snapshot to disk\n- store pointer in Run Store\n\nGoal: resume within minutes","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Checkpoint Writer\n\nOn each step completion:\n- serialize minimal state\n  (messages, tool outputs, plan)\n- write snapshot to disk\n- store pointer in Run Store\n\nGoal: resume within minutes","autoResize":true,"lineHeight":1.25},{"id":"ItqoDpN0Oxg9zNT5TTo94","type":"arrow","x":6186.635737317287,"y":-511.41282167535064,"width":0,"height":70,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b43","roundness":{"type":2},"seed":986175732,"version":36,"versionNonce":895576052,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[0,-70]],"startBinding":{"elementId":"8ZJhy9Aa44_v93wbTVZWd","mode":"orbit","fixedPoint":[0.5001,0]},"endBinding":{"elementId":"AqHekOCSTF7MMW-AlDBYo","mode":"orbit","fixedPoint":[0.5001,1]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"r2B1B05GA4j6BDJ9Uf9pS","type":"rectangle","x":5916.635737317287,"y":-481.41282167535064,"width":540,"height":210,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b44","roundness":{"type":3},"seed":600349300,"version":36,"versionNonce":1381517684,"isDeleted":false,"boundElements":[{"id":"bMOnefXhLEWjm8tYZVRZW","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"hoAuDkygf0I0hnIyxuqWb","type":"text","x":5946.635737317287,"y":-456.41282167535064,"width":500,"height":180,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b45","roundness":null,"seed":37039092,"version":36,"versionNonce":1089927924,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Periodic Backup\n(e.g., every 5–10 min)\n\n- copy DB + snapshots\n- rotate old backups\n- simple restore script\n\nLow priority obs → high value safety","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Periodic Backup\n(e.g., every 5–10 min)\n\n- copy DB + snapshots\n- rotate old backups\n- simple restore script\n\nLow priority obs → high value safety","autoResize":true,"lineHeight":1.25},{"id":"bMOnefXhLEWjm8tYZVRZW","type":"arrow","x":6466.635737317287,"y":-376.41282167535064,"width":230,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b46","roundness":{"type":2},"seed":1477676404,"version":36,"versionNonce":465796212,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-230,0]],"startBinding":{"elementId":"r2B1B05GA4j6BDJ9Uf9pS","mode":"orbit","fixedPoint":[1,0.5001]},"endBinding":{"elementId":"AqHekOCSTF7MMW-AlDBYo","mode":"orbit","fixedPoint":[0,0.86]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"si37JfPdEjmjNFWDYuJo5","type":"rectangle","x":6516.635737317287,"y":-356.41282167535064,"width":1650,"height":500,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b47","roundness":{"type":3},"seed":1990835956,"version":36,"versionNonce":1015270900,"isDeleted":false,"boundElements":[{"id":"D4OFMt2PyWAtIQaRrzYNv","type":"arrow"},{"id":"Cf650-BH0Gxup7qqt7ILF","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"90qDqDAB50SvOryUhVINt","type":"text","x":6551.635737317287,"y":-331.41282167535064,"width":780,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b48","roundness":null,"seed":377340020,"version":36,"versionNonce":1413345140,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Tools / Skills Layer","fontSize":36,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Tools / Skills Layer","autoResize":true,"lineHeight":1.25},{"id":"7VldFINpMZtGGFY1fc9jg","type":"text","x":6551.635737317287,"y":-276.41282167535064,"width":1590,"height":410,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b49","roundness":null,"seed":1867878900,"version":36,"versionNonce":53993716,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Local tools:\n- bash commands (editing code, running tests)\n- file operations (read/write/patch)\n\nMCP servers:\n- fetch structured data sources\n\nBrowser agents:\n- web search + scrape + summarize\n\nExecution rules:\n- tool call has timeout\n- tool call has max retries (decided by calling agent)\n- tool output is validated/parsed\n- failures are tolerated locally (agent continues with fallback)","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Local tools:\n- bash commands (editing code, running tests)\n- file operations (read/write/patch)\n\nMCP servers:\n- fetch structured data sources\n\nBrowser agents:\n- web search + scrape + summarize\n\nExecution rules:\n- tool call has timeout\n- tool call has max retries (decided by calling agent)\n- tool output is validated/parsed\n- failures are tolerated locally (agent continues with fallback)","autoResize":true,"lineHeight":1.25},{"id":"D4OFMt2PyWAtIQaRrzYNv","type":"arrow","x":7346.635737317287,"y":-416.41282167535064,"width":0,"height":60,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4A","roundness":{"type":2},"seed":1345794932,"version":36,"versionNonce":1895277172,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[0,60]],"startBinding":{"elementId":"OPM2rqK2rKxwB1GfxC_rr","mode":"orbit","fixedPoint":[0.5001,1]},"endBinding":{"elementId":"si37JfPdEjmjNFWDYuJo5","mode":"orbit","fixedPoint":[0.5001,0]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"1NnoxUAVsDNp3jU71pgkN","type":"rectangle","x":8266.635737317287,"y":-756.4128216753506,"width":850,"height":900,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4B","roundness":{"type":3},"seed":929604852,"version":36,"versionNonce":1682125812,"isDeleted":false,"boundElements":[{"id":"ku8hEyIzOeqoW8-zjfuO6","type":"arrow"},{"id":"U73DnRNNrVXbEULi-RMuA","type":"arrow"},{"id":"Cf650-BH0Gxup7qqt7ILF","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"HkKJjKDMJ2KzWoxQiIBpP","type":"text","x":8301.635737317287,"y":-731.4128216753506,"width":540,"height":45,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4C","roundness":null,"seed":1785718388,"version":36,"versionNonce":1528862068,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Sub-Agents (Worker Processes)","fontSize":34,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Sub-Agents (Worker Processes)","autoResize":true,"lineHeight":1.25},{"id":"wX5zqB1P-kaO2VmA-hF5Y","type":"text","x":8301.635737317287,"y":-676.4128216753506,"width":820,"height":820,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4D","roundness":null,"seed":236124148,"version":36,"versionNonce":584435444,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Each sub-agent:\n- receives (runId, subtaskId, instructions)\n- can call Tools layer\n- reports progress events\n- returns structured result\n- handles its own tool retries\n\nUseful roles:\n- Researcher (browser)\n- Code Editor (bash + diffs)\n- Data Fetcher (MCP)\n- Summarizer/Assembler\n\nFailure semantics:\n- on failure → retry automatically (bounded)\n- if still failing → return error object\n- master decides fallback / partial answer","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Each sub-agent:\n- receives (runId, subtaskId, instructions)\n- can call Tools layer\n- reports progress events\n- returns structured result\n- handles its own tool retries\n\nUseful roles:\n- Researcher (browser)\n- Code Editor (bash + diffs)\n- Data Fetcher (MCP)\n- Summarizer/Assembler\n\nFailure semantics:\n- on failure → retry automatically (bounded)\n- if still failing → return error object\n- master decides fallback / partial answer","autoResize":true,"lineHeight":1.25},{"id":"ku8hEyIzOeqoW8-zjfuO6","type":"arrow","x":8126.635737317287,"y":-666.4128216753506,"width":140,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4F","roundness":{"type":2},"seed":646220532,"version":36,"versionNonce":1877526644,"isDeleted":false,"boundElements":[{"type":"text","id":"4QzAaQvxS4lZRpqyDNiD0"}],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[140,0]],"startBinding":{"elementId":"pGS5CPB0mWTO3lqSGGCoh","mode":"orbit","fixedPoint":[1,0.52]},"endBinding":{"elementId":"1NnoxUAVsDNp3jU71pgkN","mode":"orbit","fixedPoint":[0,0.15]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"4QzAaQvxS4lZRpqyDNiD0","type":"text","x":7620.745905774318,"y":-803.7956341753506,"width":201.9359130859375,"height":35,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4G","roundness":null,"seed":421465204,"version":5,"versionNonce":587212276,"isDeleted":false,"boundElements":[],"updated":1771967922121,"link":null,"locked":false,"text":"spawn + assign","fontSize":28,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"ku8hEyIzOeqoW8-zjfuO6","originalText":"spawn + assign","autoResize":true,"lineHeight":1.25},{"id":"U73DnRNNrVXbEULi-RMuA","type":"arrow","x":8266.635737317287,"y":-591.4128216753506,"width":140,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4H","roundness":{"type":2},"seed":669867508,"version":36,"versionNonce":1981782516,"isDeleted":false,"boundElements":[{"type":"text","id":"jQHlKKvCN44lUMUOJ4H2Q"}],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-140,0]],"startBinding":{"elementId":"1NnoxUAVsDNp3jU71pgkN","mode":"orbit","fixedPoint":[0,0.24]},"endBinding":{"elementId":"pGS5CPB0mWTO3lqSGGCoh","mode":"orbit","fixedPoint":[1,0.68]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"jQHlKKvCN44lUMUOJ4H2Q","type":"text","x":7609.419909375392,"y":-728.7956341753506,"width":224.58790588378906,"height":35,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4I","roundness":null,"seed":1005944692,"version":5,"versionNonce":1500465012,"isDeleted":false,"boundElements":[],"updated":1771967922121,"link":null,"locked":false,"text":"results/progress","fontSize":28,"fontFamily":5,"textAlign":"center","verticalAlign":"middle","containerId":"U73DnRNNrVXbEULi-RMuA","originalText":"results/progress","autoResize":true,"lineHeight":1.25},{"id":"Cf650-BH0Gxup7qqt7ILF","type":"arrow","x":8266.635737317287,"y":-76.41282167535064,"width":110,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4J","roundness":{"type":2},"seed":763195636,"version":36,"versionNonce":8403828,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-110,0]],"startBinding":{"elementId":"1NnoxUAVsDNp3jU71pgkN","mode":"orbit","fixedPoint":[0,0.75]},"endBinding":{"elementId":"si37JfPdEjmjNFWDYuJo5","mode":"orbit","fixedPoint":[1,0.6]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"oTkA7rK2Ce0aBh-nsRBMO","type":"rectangle","x":8266.635737317287,"y":-801.4128216753506,"width":850,"height":330,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4K","roundness":{"type":3},"seed":1544237684,"version":36,"versionNonce":156282100,"isDeleted":false,"boundElements":[{"id":"QXMfcU0J6Y3MdGA2K4lFN","type":"arrow"},{"id":"tZgdEuToIz6JnNSelkxfA","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"93gxMdNEMomOspnz4XK2b","type":"text","x":8301.635737317287,"y":-776.4128216753506,"width":820,"height":290,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4L","roundness":null,"seed":1181008884,"version":36,"versionNonce":1377234548,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Channel Gateway (Egress)\n\n- writes outbound message record to Run Store\n- optional outbox buffer (simple local queue)\n- sends message via WhatsApp send API\n- retries transient failures\n- ensures \"at most once\" send via sendId\n\nNote: inbound dedupe & outbound dedupe are separate.","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Channel Gateway (Egress)\n\n- writes outbound message record to Run Store\n- optional outbox buffer (simple local queue)\n- sends message via WhatsApp send API\n- retries transient failures\n- ensures \"at most once\" send via sendId\n\nNote: inbound dedupe & outbound dedupe are separate.","autoResize":true,"lineHeight":1.25},{"id":"QXMfcU0J6Y3MdGA2K4lFN","type":"arrow","x":8166.635737317287,"y":-1116.4128216753506,"width":90,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4M","roundness":{"type":2},"seed":579872116,"version":36,"versionNonce":2073624564,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[90,0]],"startBinding":{"elementId":"OPM2rqK2rKxwB1GfxC_rr","mode":"orbit","fixedPoint":[1,0.28]},"endBinding":{"elementId":"oTkA7rK2Ce0aBh-nsRBMO","mode":"orbit","fixedPoint":[0,0.35]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"n6xt_y9j3iuzNLVrugi5V","type":"rectangle","x":8716.635737317287,"y":-756.4128216753506,"width":400,"height":210,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4N","roundness":{"type":3},"seed":1976784628,"version":36,"versionNonce":501014900,"isDeleted":false,"boundElements":[{"id":"tZgdEuToIz6JnNSelkxfA","type":"arrow"},{"id":"u6k7F54thTRFuD8eWwkF-","type":"arrow"}],"updated":1771967923341,"link":null,"locked":false},{"id":"E_wh--V6DiPO8MG3R6c9V","type":"text","x":8741.635737317287,"y":-731.4128216753506,"width":360,"height":180,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4O","roundness":null,"seed":750016628,"version":36,"versionNonce":1613271796,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"WhatsApp Send Client\n- calls send API\n- handles transient retries\n- logs sendId\n","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"WhatsApp Send Client\n- calls send API\n- handles transient retries\n- logs sendId\n","autoResize":true,"lineHeight":1.25},{"id":"tZgdEuToIz6JnNSelkxfA","type":"arrow","x":8711.635737317287,"y":-646.4128216753506,"width":25,"height":0,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4P","roundness":{"type":2},"seed":855190004,"version":36,"versionNonce":285348980,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[-25,0]],"startBinding":{"elementId":"n6xt_y9j3iuzNLVrugi5V","mode":"orbit","fixedPoint":[0,0.5001]},"endBinding":{"elementId":"oTkA7rK2Ce0aBh-nsRBMO","mode":"orbit","fixedPoint":[1,0.55]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"u6k7F54thTRFuD8eWwkF-","type":"arrow","x":9126.635737317287,"y":-646.4128216753506,"width":240,"height":520,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4Q","roundness":{"type":2},"seed":195545972,"version":36,"versionNonce":1043293684,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"points":[[0,0],[240,0],[240,-520]],"startBinding":{"elementId":"n6xt_y9j3iuzNLVrugi5V","mode":"orbit","fixedPoint":[1,0.52]},"endBinding":{"elementId":"poUHX1MF6o9vgGjV5Q6Ez","mode":"orbit","fixedPoint":[0,0.28]},"startArrowhead":null,"endArrowhead":"arrow","elbowed":false},{"id":"sY2sYSwG4aQrEZ7TlROsD","type":"rectangle","x":5916.635737317287,"y":-241.41282167535064,"width":540,"height":360,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4S","roundness":{"type":3},"seed":1150975604,"version":36,"versionNonce":1287030644,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false},{"id":"kssi5sdPAO44xZjCvI2KY","type":"text","x":5946.635737317287,"y":-216.41282167535064,"width":500,"height":320,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"solid","strokeWidth":3,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"index":"b4T","roundness":null,"seed":1999278068,"version":36,"versionNonce":282949876,"isDeleted":false,"boundElements":[],"updated":1771967923341,"link":null,"locked":false,"text":"Light Observability (optional)\n\n- log file with runId\n- store last N errors in DB\n- basic metrics:\n  * avg response time\n  * tool failure rate\n  * sub-agent spawn count\n\nEnough to debug without building a full platform.","fontSize":22,"fontFamily":5,"textAlign":"left","verticalAlign":"top","containerId":null,"originalText":"Light Observability (optional)\n\n- log file with runId\n- store last N errors in DB\n- basic metrics:\n  * avg response time\n  * tool failure rate\n  * sub-agent spawn count\n\nEnough to debug without building a full platform.","autoResize":true,"lineHeight":1.25}],"files":{}}
https://excalidraw.com/#json=rDtiAHS0MjJGTfN0x_TcW,Wo8k9yQKgY9g1HZjMjAayQ 
1) Core runtime (Node.js)
Language/runtime: Node.js (TypeScript)
HTTP server (webhook + send client): Fastify (or Express; Fastify is nicer under load)
Process management (sub-agents):
child_process.spawn() for simplest IPC (JSON Lines over stdio)
or worker_threads if you want shared-memory-ish patterns (usually less clean for agent isolation)
2) Orchestration layer (Master Agent)
You wrote “LangGraph Agent” in the diagram—LangGraph is Python-first, but you can still keep the concept in Node.
Two viable options:
Option A — Stay in Node (recommended for your current architecture)
State machine / graph orchestration:
xstate (very good for explicit state machines / resumability)
or a lightweight custom “node graph runner” (if you want minimal deps)
LLM framework in Node:
langchain (JS/TS) if you like the ecosystem
or a thin wrapper around the model API (often easier + more predictable)
Option B — Actually use LangGraph (Python) but keep Node for WhatsApp/tools
Python service: LangGraph runs as a separate local service (FastAPI)
Node ↔ Python: local HTTP or Unix socket
This gives you “real LangGraph” semantics, but adds a cross-language boundary.
Given “same machine, single user,” Option A is simpler and plenty.
3) State + persistence
You want periodic backup + checkpoints.
DB: SQLite (best for single machine)
Use better-sqlite3 (fast, sync, stable) or Prisma w/ SQLite (nice ergonomics)
Migrations: Prisma migrations (if using Prisma) or knex migrations
Artifacts storage: local filesystem
structured under ./runs/<runId>/...
plus ./artifacts/ for shared long-term memory files
4) Queueing / “long job” scheduling (single machine)
You can skip Redis initially and still be disciplined.
Job queue (local):
simplest: an in-process queue (p-queue) + persisted job table in SQLite
or BullMQ + Redis if you want robust retries/backoff out of the gate
Since it’s single user and 60s latency is fine, I’d start with:
p-queue for concurrency
a jobs table in SQLite for durability + resume
5) WhatsApp Business API integration
Webhook verification: signature verification per Meta docs
Send API: HTTP client with retries + idempotency on your side
HTTP client: undici (Node’s modern HTTP client) or axios
6) Tools layer (Skills / Tools / MCPs)
You have 3 tool types. Make them all look identical to the agent: Tool.call(input) -> ToolResult.
Local bash / file editing
Command execution: execa (better DX than raw child_process)
File ops: Node fs/promises
Diff/patch: diff library or generate unified diffs yourself
MCP servers
MCP client: whatever MCP SDK you’re using (TS client)
Normalize MCP calls into the same ToolResult schema.
Browser agent (web search + scrape)
Pick one:
Playwright (recommended): stable automation + supports “real browsing”
Puppeteer (also ok)
Also consider a “cheap mode”:
Use a search API (or your own scraping) + fetch pages via HTTP when JS not needed.
7) Structured outputs + validation
This is how you stop the agent from hallucinating its way into broken tool calls.
Schema validation: zod
Logging shape: every tool result is { ok, data?, error?, meta }
8) Retries + timeouts
Retry library: p-retry or custom exponential backoff
Timeouts: p-timeout or AbortController
Retries are triggered by the calling agent (as you want), but implemented by a shared helper.
9) Minimal observability (lightweight)
Logging: pino (fast structured logs)
Run correlation: always include runId, stepId, subtaskId
Optional metrics: prom-client if you want basic numbers later
10) Packaging / running
Dev: tsx + nodemon
Prod-ish: pm2 or just node dist/index.js with a systemd unit
Config: dotenv + typed config module


